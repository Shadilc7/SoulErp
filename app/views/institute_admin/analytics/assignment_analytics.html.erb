<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Assignment Analytics: <%= @assignment.title %></h1>
    <%= link_to institute_admin_analytics_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
    <% end %>
  </div>
  
  <!-- Date Range Selector -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <%= form_with url: assignment_analytics_institute_admin_analytics_path(assignment_id: @assignment.id), method: :get, class: "row g-3 align-items-center", data: { controller: "autosubmit" } do |f| %>
        <div class="col-md-4">
          <label class="form-label">Date Range</label>
          <div class="input-group">
            <%= f.date_field :start_date, value: @start_date, class: "form-control", data: { action: "change->autosubmit#submit" } %>
            <span class="input-group-text">to</span>
            <%= f.date_field :end_date, value: @end_date, class: "form-control", data: { action: "change->autosubmit#submit" } %>
          </div>
        </div>
        <div class="col-md-2">
          <%= f.submit "Apply", class: "btn btn-primary mt-4" %>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Assignment Overview -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3"><%= @assignment.title %></h5>
          <p class="text-muted mb-3"><%= @assignment.description %></p>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Date Range:</span>
            <span><%= @assignment.start_date.strftime("%b %d") %> - <%= @assignment.end_date.strftime("%b %d, %Y") %></span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Type:</span>
            <span><%= @assignment.assignment_type.titleize %></span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Questions:</span>
            <span><%= @assignment.questions.count %></span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Completion Rate:</span>
            <span><%= @completion_rate %>%</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Daily Completion Trend</h5>
        </div>
        <div class="card-body">
          <canvas id="dailyCompletionChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Question Analysis -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Question Analysis</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <% @question_analysis.each_with_index do |question, index| %>
              <div class="col-md-6 mb-4">
                <div class="card border">
                  <div class="card-header bg-light">
                    <h6 class="mb-0"><%= question[:title] %></h6>
                    <small class="text-muted"><%= question[:question_type].titleize %></small>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                      <span>Response Count:</span>
                      <span><%= question[:response_count] %></span>
                    </div>
                    
                    <% if question[:option_distribution].present? %>
                      <h6 class="mb-3">Option Distribution</h6>
                      <canvas id="optionChart<%= index %>" height="150"></canvas>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Section Comparison (if applicable) -->
  <% if @section_comparison.present? %>
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0">Section Comparison</h5>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-8 mx-auto">
                <canvas id="sectionComparisonChart" height="200"></canvas>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Section</th>
                    <th>Participants Completed</th>
                    <th>Completion</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @section_comparison.each do |section| %>
                    <tr>
                      <td><%= section[:name] %></td>
                      <td><%= section[:completed_count] %> / <%= section[:total_count] %></td>
                      <td>
                        <div class="progress" style="height: 8px;">
                          <div class="progress-bar bg-success" role="progressbar" style="width: <%= section[:completion_percentage] %>%"></div>
                        </div>
                        <small class="text-muted"><%= section[:completion_percentage] %>%</small>
                      </td>
                      <td>
                        <%= link_to section_performance_institute_admin_analytics_path(section_id: section[:id]), class: "btn btn-sm btn-outline-secondary" do %>
                          <i class="bi bi-bar-chart-fill"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% content_for :scripts do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Daily Completion Chart
      const dailyCtx = document.getElementById('dailyCompletionChart').getContext('2d');
      
      // Generate dates between start and end date
      const startDate = new Date('<%= @start_date.strftime("%Y-%m-%d") %>');
      const endDate = new Date('<%= @end_date.strftime("%Y-%m-%d") %>');
      const dateLabels = [];
      const completionData = [];
      
      for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
        const dateString = date.toISOString().split('T')[0];
        dateLabels.push(dateString);
        completionData.push(<%= raw @daily_completion.to_json %>[dateString] || 0);
      }
      
      new Chart(dailyCtx, {
        type: 'line',
        data: {
          labels: dateLabels,
          datasets: [{
            label: 'Participants Completed',
            data: completionData,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Option Distribution Charts
      <% @question_analysis.each_with_index do |question, index| %>
        <% if question[:option_distribution].present? %>
          const optionCtx<%= index %> = document.getElementById('optionChart<%= index %>').getContext('2d');
          const optionLabels<%= index %> = <%= raw question[:option_distribution].keys.to_json %>;
          const optionData<%= index %> = <%= raw question[:option_distribution].values.to_json %>;
          
          new Chart(optionCtx<%= index %>, {
            type: 'bar',
            data: {
              labels: optionLabels<%= index %>,
              datasets: [{
                label: 'Responses',
                data: optionData<%= index %>,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        <% end %>
      <% end %>
      
      <% if @section_comparison.present? %>
        // Section Comparison Chart
        const sectionCtx = document.getElementById('sectionComparisonChart').getContext('2d');
        const sectionData = <%= raw @section_comparison.to_json %>;
        const sectionLabels = sectionData.map(s => s.name);
        const sectionCompletionData = sectionData.map(s => s.completion_percentage);
        
        new Chart(sectionCtx, {
          type: 'bar',
          data: {
            labels: sectionLabels,
            datasets: [{
              label: 'Completion Rate (%)',
              data: sectionCompletionData,
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      <% end %>
    });
  </script>
<% end %> 