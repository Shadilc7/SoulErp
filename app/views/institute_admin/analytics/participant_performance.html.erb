<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Participant Performance: <%= @participant.user.full_name %></h1>
    <%= link_to institute_admin_analytics_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
    <% end %>
  </div>
  
  <!-- Date Range Selector -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <%= form_with url: participant_performance_institute_admin_analytics_path(participant_id: @participant.id), method: :get, class: "row g-3 align-items-center", data: { controller: "autosubmit" } do |f| %>
        <div class="col-md-4">
          <label class="form-label">Date Range</label>
          <div class="input-group">
            <%= f.date_field :start_date, value: @start_date, class: "form-control", data: { action: "change->autosubmit#submit" } %>
            <span class="input-group-text">to</span>
            <%= f.date_field :end_date, value: @end_date, class: "form-control", data: { action: "change->autosubmit#submit" } %>
          </div>
        </div>
        <div class="col-md-2">
          <%= f.submit "Apply", class: "btn btn-primary mt-4" %>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Participant Info -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="avatar-circle bg-primary text-white me-3">
              <%= @participant.user.full_name.first.upcase %>
            </div>
            <div>
              <h5 class="mb-0"><%= @participant.user.full_name %></h5>
              <p class="text-muted mb-0"><%= @participant.section&.name || "No Section" %></p>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-6">
              <div class="border rounded p-3 text-center">
                <h6 class="text-muted mb-1">Assignments</h6>
                <h4 class="mb-0"><%= @assignments.count %></h4>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-3 text-center">
                <h6 class="text-muted mb-1">Avg. Completion</h6>
                <h4 class="mb-0"><%= calculate_participant_completion_rate(@participant) %>%</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Completion Over Time</h5>
        </div>
        <div class="card-body">
          <canvas id="completionChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Assignment Details -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Assignment Details</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Assignment</th>
                  <th>Date Range</th>
                  <th>Days Completed</th>
                  <th>Completion</th>
                </tr>
              </thead>
              <tbody>
                <% @assignment_details.each do |assignment| %>
                  <tr>
                    <td><%= assignment[:title] %></td>
                    <td>
                      <% a = Assignment.find(assignment[:id]) %>
                      <%= a.start_date.strftime("%b %d") %> - <%= a.end_date.strftime("%b %d, %Y") %>
                    </td>
                    <td><%= assignment[:completed_days] %> / <%= assignment[:total_days] %></td>
                    <td>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: <%= assignment[:completion_percentage] %>%"></div>
                      </div>
                      <small class="text-muted"><%= assignment[:completion_percentage] %>%</small>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Response Patterns -->
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Response Time of Day</h5>
        </div>
        <div class="card-body">
          <canvas id="timeOfDayChart" height="200"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Response Day of Week</h5>
        </div>
        <div class="card-body">
          <canvas id="dayOfWeekChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :styles do %>
  <style>
    .avatar-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
<% end %>

<% content_for :scripts do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Completion Over Time Chart
      const completionCtx = document.getElementById('completionChart').getContext('2d');
      
      // Generate dates between start and end date
      const startDate = new Date('<%= @start_date.strftime("%Y-%m-%d") %>');
      const endDate = new Date('<%= @end_date.strftime("%Y-%m-%d") %>');
      const dateLabels = [];
      const completionData = [];
      
      for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
        const dateString = date.toISOString().split('T')[0];
        dateLabels.push(dateString);
        completionData.push(<%= raw @completion_by_date.to_json %>[dateString] || 0);
      }
      
      new Chart(completionCtx, {
        type: 'line',
        data: {
          labels: dateLabels,
          datasets: [{
            label: 'Assignments Completed',
            data: completionData,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Time of Day Chart
      const timeOfDayCtx = document.getElementById('timeOfDayChart').getContext('2d');
      const timeLabels = Array.from({length: 24}, (_, i) => i);
      const timeData = timeLabels.map(hour => <%= raw @response_patterns[:time_of_day].to_json %>[hour] || 0);
      
      new Chart(timeOfDayCtx, {
        type: 'bar',
        data: {
          labels: timeLabels.map(hour => `${hour}:00`),
          datasets: [{
            label: 'Submissions',
            data: timeData,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Day of Week Chart
      const dayOfWeekCtx = document.getElementById('dayOfWeekChart').getContext('2d');
      const dayLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayData = dayLabels.map((_, i) => <%= raw @response_patterns[:day_of_week].to_json %>[i] || 0);
      
      new Chart(dayOfWeekCtx, {
        type: 'bar',
        data: {
          labels: dayLabels,
          datasets: [{
            label: 'Submissions',
            data: dayData,
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    });
  </script>
<% end %> 