<%= form_with(model: [:institute_admin, @question], local: true, data: { controller: "question-form nested-form" }) do |f| %>
  <% if @question.errors.any? %>
    <div class="alert alert-danger">
      <h6>Please fix the following errors:</h6>
      <ul class="mb-0">
        <% @question.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Question Title -->
  <div class="question-preview-card mb-4">
    <div class="mb-4">
      <div class="question-input-group">
        <%= f.text_field :title, 
            class: "form-control form-control-lg",
            placeholder: "Enter your question",
            data: { 
              question_form_target: "titleInput",
              action: "input->question-form#validateForm"
            } %>
      </div>
    </div>

    <!-- Question Description -->
    <div class="mb-4">
      <div class="question-input-group">
        <%= f.text_area :description,
            class: "form-control",
            rows: 3,
            placeholder: "Enter question description (optional)" %>
      </div>
    </div>

    <!-- Question Type Selection -->
    <div class="row mb-3">
      <div class="col-md-12">
        <%= f.label :question_type, class: "form-label" %>
        <%= f.select :question_type,
            options_for_select(Question.question_types.keys.map { |k| [k.titleize, k] }, @question.question_type),
            { include_blank: "Select Question Type" },
            { class: "form-select", required: true, data: { action: "change->question-form#handleTypeChange" } } %>
      </div>
    </div>

    <!-- Rating options (for rating type) -->
    <div class="row mb-3 rating-options" style="<%= @question.rating? ? '' : 'display: none;' %>">
      <div class="col-md-6">
        <%= f.label :max_rating, "Maximum Rating (1-10 stars)", class: "form-label" %>
        <%= f.select :max_rating, 
                       options_for_select((1..10).map { |n| [pluralize(n, "star"), n] }, @question.max_rating || 5),
                       {}, 
                       { class: "form-select" } %>
      </div>
      <div class="col-md-6">
        <label class="form-label">Preview</label>
        <div class="rating-preview">
          <% (1..5).each do |i| %>
            <i class="bi bi-star-fill text-warning fs-3 me-1"></i>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Dynamic Answer Options -->
    <div class="answer-options-wrapper mt-4" 
        data-question-form-target="optionsWrapper">
      
      <!-- Short Answer Preview -->
      <div class="answer-preview short-answer d-none"
          data-question-form-target="shortAnswerPreview">
        <input type="text" class="form-control" 
            placeholder="Short answer text" disabled>
      </div>

      <!-- Paragraph Preview -->
      <div class="answer-preview paragraph d-none"
          data-question-form-target="paragraphPreview">
        <textarea class="form-control" rows="3" 
            placeholder="Long answer text" disabled></textarea>
      </div>

      <!-- Multiple Choice/Checkbox Options -->
      <div class="options-container" style="<%= @question.requires_options? ? '' : 'display: none;' %>" data-question-form-target="optionsSection">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label text-muted small text-uppercase mb-0">Answer Options</label>
          <button type="button" 
              class="btn btn-primary btn-sm"
              data-action="nested-form#add">
            <i class="bi bi-plus-lg"></i> Add Option
          </button>
        </div>

        <template data-nested-form-target="template">
          <%= f.fields_for :options, Option.new, child_index: 'NEW_RECORD' do |option| %>
            <div class="option-item mb-3">
              <div class="d-flex align-items-center gap-3">
                <div class="option-indicator">
                  <i class="bi bi-circle"></i>
                </div>
                <%= option.text_field :text, 
                    class: "form-control",
                    placeholder: "Option text",
                    required: true,
                    value: option.object.text.presence || "Option #{Time.now.to_i}" %>
                <div class="form-check">
                  <%= option.check_box :correct, class: "form-check-input" %>
                  <label class="form-check-label small">Correct</label>
                </div>
                <button type="button" 
                    class="btn btn-outline-danger btn-sm"
                    data-action="nested-form#remove">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          <% end %>
        </template>

        <div data-nested-form-target="items">
          <%= f.fields_for :options do |option| %>
            <div class="option-item mb-3">
              <div class="d-flex align-items-center gap-3">
                <div class="option-indicator">
                  <i class="bi bi-circle"></i>
                </div>
                <%= option.text_field :text, 
                    class: "form-control",
                    placeholder: "Option text",
                    required: true,
                    value: option.object.text.presence || "Option #{Time.now.to_i}" %>
                <div class="form-check">
                  <%= option.check_box :correct, class: "form-check-input" %>
                  <label class="form-check-label small">Correct</label>
                </div>
                <button type="button" 
                    class="btn btn-outline-danger btn-sm"
                    data-action="nested-form#remove">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Date Preview -->
      <div class="answer-preview date d-none"
          data-question-form-target="datePreview">
        <input type="date" class="form-control" disabled>
      </div>

      <!-- Time Preview -->
      <div class="answer-preview time d-none"
          data-question-form-target="timePreview">
        <input type="time" class="form-control" disabled>
      </div>

      <!-- Number Preview -->
      <div class="answer-preview number d-none"
          data-question-form-target="numberPreview">
        <input type="number" class="form-control" disabled placeholder="Enter a number">
      </div>
    </div>
  </div>

  <!-- Question Settings -->
  <div class="row g-4">
    <div class="col-md-6">
      <div class="detail-card">
        <div class="detail-icon">
          <i class="bi bi-asterisk"></i>
        </div>
        <div class="detail-content">
          <h6>Required</h6>
          <div class="form-check form-switch">
            <%= f.check_box :required, class: "form-check-input", data: { action: "change->question-form#toggleRequired" } %>
            <label class="form-check-label">
              Make this question required
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="form-actions mt-4 d-flex gap-2">
    <%= f.submit @question.new_record? ? "Create Question" : "Update Question", 
        class: "btn btn-primary",
        data: { question_form_target: "submitButton" } %>
    <%= link_to "Cancel", 
        @question.new_record? ? institute_admin_questions_path : institute_admin_question_path(@question), 
        class: "btn btn-secondary" %>
  </div>
<% end %>

<% content_for :styles do %>
  <style>
    .question-input-group {
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 1.5rem;
      background: white;
      transition: all 0.3s ease;
    }

    .question-input-group:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(152, 216, 170, 0.25);
    }

    .question-type-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .question-type-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .question-type-card.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .question-type-card .type-icon {
      width: 48px;
      height: 48px;
      background: #f8f9fa;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      margin: 0 auto 1rem;
      color: var(--primary-color);
      transition: all 0.3s ease;
    }

    .question-type-card.active .type-icon {
      background: white;
    }

    .question-type-card .type-label {
      font-weight: 500;
    }

    .question-type-select {
      position: relative;
    }

    .question-type-dropdown {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 1px solid #dee2e6;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .question-type-dropdown:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(152, 216, 170, 0.25);
    }

    .question-type-dropdown option {
      padding: 10px;
    }

    /* Style for the select options */
    select.question-type-dropdown option i {
      margin-right: 8px;
    }

    /* Rest of the styles from show.html.erb */
  </style>
<% end %> 