<div class="container-fluid py-4" data-controller="certificate-publisher">
  <%= render 'certificate_breadcrumb', current_page: "View Certificates" %>

  <div class="card card-custom">
    <div class="card-header card-header-custom">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Generated Certificates</h5>
        <div>
          <%= link_to generate_certificate_institute_admin_reports_path, class: "btn btn-primary btn-sm" do %>
            <i class="bi bi-plus-circle me-1"></i>Generate New Certificate
          <% end %>
        </div>

    </div>

    <div class="card-body">
      <% if @certificates.any? %>
        <!-- Filters -->
        <div class="filters mb-4 p-3 bg-light rounded-3">
          <div class="row g-3 align-items-center">
            <div class="col-auto">
              <select class="form-select" id="sectionFilter" style="width: 260px; min-width: 160px;">
                <option value="">All Sections</option>
                <% current_institute.sections.active.each do |section| %>
                  <option value="<%= section.id %>"><%= section.name %></option>
                <% end %>
              </select>
            </div>
            <div class="col text-end d-flex gap-2 justify-content-end align-items-center">
              <div class="btn-group" role="group" aria-label="Bulk actions">
                <%= button_tag type: 'button', class: 'btn btn-sm btn-success', id: 'publishSelected', disabled: true, title: 'Publish selected certificates' do %>
                  <i class="bi bi-check2-all me-1"></i>Publish
                <% end %>
                <%= button_tag type: 'button', class: 'btn btn-sm btn-warning text-dark', id: 'unpublishSelected', disabled: true, title: 'Unpublish selected certificates' do %>
                  <i class="bi bi-eye-slash me-1"></i>Unpublish
                <% end %>
                <%= button_tag type: 'button', class: 'btn btn-sm btn-secondary', id: 'downloadSelected', disabled: true, title: 'Download selected certificates' do %>
                  <i class="bi bi-download me-1"></i>Download
                <% end %>
                <%= button_tag type: 'button', class: 'btn btn-sm btn-info text-white', id: 'regenerateSelected', disabled: true, title: 'Regenerate selected certificates' do %>
                  <i class="bi bi-arrow-clockwise me-1"></i>Regenerate
                <% end %>
                <%= button_tag type: 'button', class: 'btn btn-sm btn-danger', id: 'deleteSelected', disabled: true, title: 'Delete selected certificates' do %>
                  <i class="bi bi-trash me-1"></i>Delete
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th width="40">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                  </div>
                </th>
                <th>Assignment</th>
                <th>Participant</th>
                <th>Generated</th>
                <th>Status</th>
                <th class="text-end" style="white-space: nowrap; width: 1%;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @certificates.each do |certificate| %>
                <tr class="certificate-row" 
                    data-section="<%= certificate.participant&.section&.id || '' %>">
                  <td>
                    <div class="form-check">
                      <input class="form-check-input certificate-checkbox" type="checkbox" 
                             value="<%= certificate.id %>"
                             data-published="<%= certificate.published? %>"
                             <%= 'checked' if certificate.published? %>>
                    </div>
                  </td>
                  <td>
                    <%= certificate.assignment.title %>
                  </td>
                  <td>
                    <%= certificate.participant.user.full_name %>
                    <br>
                    <small class="text-muted"><%= certificate.participant.section&.name || "No Section" %></small>
                  </td>
                  <td><%= certificate.generated_at.strftime("%b %d, %Y") %></td>
                  <td>
                    <span class="badge <%= certificate.published? ? 'bg-success' : 'bg-secondary' %>">
                      <%= certificate.published? ? 'Published' : 'Not Published' %>
                    </span>
                  </td>
                  <td style="white-space: nowrap;">
                    <div class="d-flex flex-row flex-nowrap gap-1 justify-content-end align-items-center" style="min-width: 220px;">

                      <%= link_to toggle_publish_certificate_institute_admin_report_path(certificate),
                          class: "btn btn-sm #{certificate.published? ? 'btn-warning text-dark shadow-sm' : 'btn-success shadow-sm'} fw-bold px-3",
                          title: certificate.published? ? "Unpublish" : "Publish",
                          data: { turbo_method: :post, turbo_confirm: "Are you sure you want to #{certificate.published? ? 'unpublish' : 'publish'} this certificate?" } do %>
                        <i class="bi <%= certificate.published? ? 'bi-eye-slash' : 'bi-eye' %>"></i>
                        <%= certificate.published? ? 'Unpublish' : 'Publish' %>
                      <% end %>
                      <%= link_to view_certificate_institute_admin_reports_path(certificate, format: :pdf),
                          class: "btn btn-sm btn-primary shadow-sm",
                          title: "View Certificate",
                          target: "_blank" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= button_to regenerate_certificate_institute_admin_reports_path(certificate),
                          method: :post,
                          class: "btn btn-sm btn-info text-white shadow-sm #{'disabled' if certificate.published?}",
                          form: { style: 'display: inline-block' },
                          disabled: certificate.published?,
                          title: (certificate.published? ? 'Cannot regenerate a published certificate' : 'Regenerate Certificate'),
                          data: { turbo_confirm: "Are you sure you want to regenerate this certificate?" } do %>
                        <i class="bi bi-arrow-clockwise"></i>
                      <% end %>
                      <%= link_to download_certificate_on_demand_institute_admin_report_path(certificate),
                          class: "btn btn-sm btn-secondary shadow-sm",
                          title: "Download Certificate",
                          download: "certificate-#{certificate.id}.pdf" do %>
                        <i class="bi bi-download"></i>
                      <% end %>
                      <%= button_to delete_certificate_institute_admin_reports_path(certificate),
                          method: :delete,
                          class: "btn btn-sm btn-danger shadow-sm #{'disabled' if certificate.published?}",
                          form: { style: 'display: inline-block' },
                          disabled: certificate.published?,
                          title: (certificate.published? ? 'Cannot delete a published certificate' : 'Delete Certificate'),
                          data: { turbo_confirm: "Are you sure you want to delete this certificate?" } do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>


        <!-- Pagination -->
        <!-- ...existing code... -->

      <!-- JavaScript behavior moved to Stimulus controller: app/javascript/controllers/certificate_publisher_controller.js -->

      <% end %>
    </div> <!-- .card-body -->
  </div> <!-- .card -->
</div> <!-- .container-fluid -->