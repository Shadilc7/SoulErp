<div class="container-fluid py-4" data-controller="certificate-publisher">
  <%= render 'certificate_breadcrumb', current_page: "View Certificates" %>

  <div class="card card-custom mt-3">
    <div class="card-header card-header-custom py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Generated Certificates</h5>
        <div></div>
      </div>
    </div>

    <div class="card-body">

        <style>
          /* Nudge filter labels slightly upward for better vertical alignment with selects */
          .filters .filter-label { display: inline-flex; align-items: center; transform: translateY(-3px); }
          @media (max-width: 767px) {
            .filters .filter-label { transform: translateY(-1px); }
          }
        </style>

        <!-- Filters (responsive for mobile) -->
        <div class="filters mb-3 p-3 bg-white rounded-3 shadow-sm border">
          <%= form_with url: view_certificates_institute_admin_reports_path, method: :get, local: true, class: 'd-flex flex-column flex-md-row align-items-center gap-3', html: { style: 'gap: 1rem' } do |f| %>

            <div class="d-flex flex-column flex-md-row align-items-center gap-2 me-md-3" style="min-width: 0;">
              <label for="sectionFilter" class="d-flex align-items-center mb-0 text-muted small me-3 filter-label">Section</label>
              <%= select_tag :section_id, options_for_select([['All Sections', '']] + current_institute.sections.active.map { |s| [s.name, s.id] }, @section_id), class: 'form-select form-select-sm flex-fill', id: 'sectionFilter', onchange: 'this.form.submit()', style: 'min-width: 180px; max-width: 320px;' %>
            </div>

            <div class="d-flex flex-column flex-md-row align-items-center gap-2 me-md-3" style="min-width: 0;">
              <label for="configFilter" class="d-flex align-items-center mb-0 text-muted small me-3 filter-label">Configuration</label>
              <%= select_tag :certificate_configuration_id, options_for_select([['All Configurations', '']] + (@certificate_configurations || []).map { |c| [c.name, c.id] }, @certificate_configuration_id), class: 'form-select form-select-sm flex-fill', id: 'configFilter', onchange: 'this.form.submit()', style: 'min-width: 200px; max-width: 360px;' %>
            </div>

            <div class="ms-md-auto d-block mt-2 mt-md-0">
              <%= link_to 'Reset', view_certificates_institute_admin_reports_path, class: 'btn btn-sm btn-outline-secondary d-inline-flex align-items-center form-select-sm py-1 px-3' %>
            </div>

          <% end %>
        </div>

        <!-- Bulk actions (separate section) -->
        <div class="bulk-actions mb-4 p-3 bg-white rounded-3 shadow-sm border">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong class="me-2">Bulk actions</strong>
              <small class="text-muted">Select certificates to apply</small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <%= button_tag type: 'button', class: 'btn btn-sm btn-success shadow-sm', id: 'publishSelected', disabled: true, title: 'Publish selected certificates' do %>
                <i class="bi bi-check2-all me-1"></i> Publish
              <% end %>
              <%= button_tag type: 'button', class: 'btn btn-sm btn-warning text-dark shadow-sm', id: 'unpublishSelected', disabled: true, title: 'Unpublish selected certificates' do %>
                <i class="bi bi-eye-slash me-1"></i> Unpublish
              <% end %>
              <%= button_tag type: 'button', class: 'btn btn-sm btn-secondary shadow-sm', id: 'downloadSelected', disabled: true, title: 'Download selected certificates' do %>
                <i class="bi bi-download"></i>
              <% end %>
              <%= button_tag type: 'button', class: 'btn btn-sm btn-info text-white shadow-sm', id: 'regenerateSelected', disabled: true, title: 'Regenerate selected certificates' do %>
                <i class="bi bi-arrow-clockwise"></i>
              <% end %>
              <%= button_tag type: 'button', class: 'btn btn-sm btn-danger shadow-sm', id: 'deleteSelected', disabled: true, title: 'Delete selected certificates' do %>
                <i class="bi bi-trash"></i>
              <% end %>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th width="40">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                  </div>
                </th>
                <th>Assignment</th>
                <th>Participant</th>
                <th>Generated</th>
                <th>Configuration</th>
                <th class="text-end" style="white-space: nowrap; width: 1%;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @certificates.each do |certificate| %>
                <tr class="certificate-row" 
                    data-section="<%= certificate.participant&.section&.id || '' %>">
                  <td>
                    <div class="form-check">
                      <input class="form-check-input certificate-checkbox" type="checkbox" 
                             value="<%= certificate.id %>"
                             data-published="<%= certificate.published? %>"
                             <%= 'checked' if certificate.published? %>>
                    </div>
                  </td>
                  <td>
                    <%= certificate.assignment.title %>
                  </td>
                  <td>
                    <% if certificate.participant && certificate.participant.user %>
                      <%= link_to certificate.participant.user.full_name, institute_admin_participant_path(certificate.participant.user), class: 'text-decoration-none' %>
                    <% else %>
                      <%= certificate.participant&.user&.full_name || 'Unknown Participant' %>
                    <% end %>
                  </td>
                  <td><%= certificate.generated_at.strftime("%b %d, %Y") %></td>
                  <td>
                    <%= certificate.certificate_configuration&.name || 'â€”' %>
                  </td>
                  <td style="white-space: nowrap;">
                    <div class="d-flex flex-row flex-nowrap gap-1 justify-content-end align-items-center" style="min-width: 220px;">

                      <%= link_to toggle_publish_certificate_institute_admin_report_path(certificate),
                          class: "btn btn-sm #{certificate.published? ? 'btn-warning text-dark shadow-sm' : 'btn-success shadow-sm'} fw-bold px-3",
                          title: certificate.published? ? "Unpublish" : "Publish",
                          data: { turbo_method: :post, turbo_confirm: "Are you sure you want to #{certificate.published? ? 'unpublish' : 'publish'} this certificate?" } do %>
                        <i class="bi <%= certificate.published? ? 'bi-eye-slash' : 'bi-eye' %>"></i>
                        <%= certificate.published? ? 'Unpublish' : 'Publish' %>
                      <% end %>
                      <%= link_to view_certificate_institute_admin_reports_path(certificate, format: :pdf),
                          class: "btn btn-sm btn-primary shadow-sm",
                          title: "View Certificate",
                          target: "_blank" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= button_to regenerate_certificate_institute_admin_reports_path(certificate),
                          method: :post,
                          class: "btn btn-sm btn-info text-white shadow-sm #{'disabled' if certificate.published?}",
                          form: { style: 'display: inline-block' },
                          disabled: certificate.published?,
                          title: (certificate.published? ? 'Cannot regenerate a published certificate' : 'Regenerate Certificate'),
                          data: { turbo_confirm: "Are you sure you want to regenerate this certificate?" } do %>
                        <i class="bi bi-arrow-clockwise"></i>
                      <% end %>
                      <%= link_to download_certificate_on_demand_institute_admin_report_path(certificate),
                          class: "btn btn-sm btn-secondary shadow-sm",
                          title: "Download Certificate",
                          download: "certificate-#{certificate.id}.pdf" do %>
                        <i class="bi bi-download"></i>
                      <% end %>
                      <%= button_to delete_certificate_institute_admin_reports_path(certificate),
                          method: :delete,
                          class: "btn btn-sm btn-danger shadow-sm #{'disabled' if certificate.published?}",
                          form: { style: 'display: inline-block' },
                          disabled: certificate.published?,
                          title: (certificate.published? ? 'Cannot delete a published certificate' : 'Delete Certificate'),
                          data: { turbo_confirm: "Are you sure you want to delete this certificate?" } do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
              <% if @certificates.empty? %>
                <tr>
                  <td colspan="6" class="text-center py-3">No certificates found.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>


        <!-- Pagination -->
        <!-- ...existing code... -->

      <!-- JavaScript behavior moved to Stimulus controller: app/javascript/controllers/certificate_publisher_controller.js -->

    </div> <!-- .card-body -->
  </div> <!-- .card -->
</div> <!-- .container-fluid -->